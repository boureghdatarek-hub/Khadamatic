<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø®Ø¯Ù…Ø§ØªÙŠ - Ø·Ù„Ø¨Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --secondary: #16a34a; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; color: #334155; }
        .header { background: #1e293b; color: white; text-align: center; padding: 20px; }
        .main-container { display: flex; flex-wrap: wrap; min-height: 80vh; }
        .section { flex: 1; min-width: 350px; padding: 20px; box-sizing: border-box; }
        .market-section { border-left: 2px solid #e2e8f0; background: #f0fdf4; }
        .task-section { background: #eff6ff; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Cairo'; font-size: 14px; }
        .price-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .qty-controls { display: flex; gap: 10px; align-items: center; }
        .btn-qty { background: #e2e8f0; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-order { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; color: white; transition: 0.3s; }
        #total-price { font-size: 1.3rem; font-weight: bold; color: var(--secondary); text-align: center; margin: 15px 0; border-top: 2px dashed #ccc; padding-top: 10px; }
        .update-tag { text-align: center; font-size: 13px; color: #64748b; margin-top: 10px; background: #e2e8f0; padding: 5px; border-radius: 5px; display: inline-block; width: 100%; }
        @media (max-width: 768px) { .main-container { flex-direction: column; } }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸš€ Ù…Ù†ØµØ© Ø®Ø¯Ù…Ø§ØªÙƒ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</h1>
    <div id="last-update" class="update-tag">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>
</div>

<div class="main-container">
    <div class="section market-section">
        <h2 style="color:var(--secondary)">ğŸ Ø³ÙˆÙ‚ Ø§Ù„Ø®Ø¶Ø± ÙˆØ§Ù„ÙÙˆØ§ÙƒÙ‡</h2>
        <div class="card">
            <div id="market-list">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±...</div>
            <div id="total-price">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¯Ø¬</div>
            <hr>
            <input type="text" id="cust-name" placeholder="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
            <input type="text" id="cust-addr" placeholder="ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„">
            <label>ğŸ›µ Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØµÙ„ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹:</label>
            <select id="delivery-driver"><option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option></select>
            <button class="btn-order" style="background:var(--secondary)" onclick="sendMarketOrder()">ğŸ›’ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
    </div>

    <div class="section task-section">
        <h2 style="color:var(--primary)">ğŸ“„ Ø®Ø¯Ù…Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©</h2>
        <div class="card">
            <select id="task-type">
                <option value="ÙˆØ«Ø§Ø¦Ù‚">Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØ«Ø§Ø¦Ù‚</option>
                <option value="ÙÙˆØ§ØªÙŠØ±">Ø¯ÙØ¹ ÙÙˆØ§ØªÙŠØ±</option>
                <option value="ØªÙˆØµÙŠÙ„">ØªÙˆØµÙŠÙ„ Ø£Ù…Ø§Ù†Ø©</option>
            </select>
            <textarea id="task-desc" rows="3" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„..."></textarea>
            <input type="text" id="task-name" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…">
            <input type="text" id="task-addr" placeholder="ğŸ“ Ø§Ù„Ù…ÙƒØ§Ù†">
            <label>ğŸ›µ Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØµÙ„ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹:</label>
            <select id="task-driver"><option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option></select>
            <button class="btn-order" style="background:var(--primary)" onclick="sendTaskOrder()">âš¡ Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwbJH5jb4pg-MeDuZLe_cjuw0a9WHAm-Eu1R97bGPduCdcMw3D_MxnfZGeuW-koswp6hQ/exec';
    let marketData = [];
    let cart = {};

    async function initializeApp() {
        try {
            const res = await fetch(scriptURL + '?nocache=' + new Date().getTime());
            const data = await res.json();
            marketData = data.prices;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
            document.getElementById('market-list').innerHTML = marketData.map((item, index) => `
                <div class="price-item">
                    <span>${item.name} (${item.price} Ø¯Ø¬)</span>
                    <div class="qty-controls">
                        <button class="btn-qty" onclick="updateQty(${index}, -1)">-</button>
                        <span id="qty-${index}">${cart[item.name]?.q || 0}</span>
                        <button class="btn-qty" onclick="updateQty(${index}, 1)">+</button>
                    </div>
                </div>`).join('');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØµÙ„ÙŠÙ†
            updateDriverSelect('delivery-driver', data.marketDrivers);
            updateDriverSelect('task-driver', data.adminDrivers);

            const now = new Date();
            document.getElementById('last-update').innerText = `âœ… ØªØ­Ø¯ÙŠØ« Ø­ÙŠ: ${now.toLocaleTimeString()}`;
        } catch(e) { console.error(e); }
    }

    function updateDriverSelect(id, list) {
        const select = document.getElementById(id);
        if(list && list.length > 0) {
            select.innerHTML = list.map(d => `<option value="${d.phone}">${d.name}</option>`).join('');
        } else {
            select.innerHTML = '<option>âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØµÙ„ Ù…ØªØ§Ø­</option>';
        }
    }

    function updateQty(idx, change) {
        const qtySpan = document.getElementById(`qty-${idx}`);
        let q = Math.max(0, parseInt(qtySpan.innerText) + change);
        qtySpan.innerText = q;
        const item = marketData[idx];
        if(q > 0) cart[item.name] = { q, total: q * item.price }; else delete cart[item.name];
        let total = 0; for(let n in cart) total += cart[n].total;
        document.getElementById('total-price').innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¯Ø¬`;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³ÙˆÙ‚ + Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØµÙ„ Ù„Ù„Ø³ÙŠØ±ÙØ±
    async function sendMarketOrder() {
        const name = document.getElementById('cust-name').value;
        const addr = document.getElementById('cust-addr').value;
        const driverPhone = document.getElementById('delivery-driver').value;
        
        if(!name || !addr || driverPhone.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

        let details = ""; let total = 0;
        for(let n in cart) { details += `${n}: ${cart[n].q} ÙƒØº\n`; total += cart[n].total; }
        if(total === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ÙˆØµÙ„ Ø¥Ù„Ù‰ "Ù…Ø´ØºÙˆÙ„"
        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({
            type: "Ø³ÙˆÙ‚", customer: name, details: details, address: addr, driverPhone: driverPhone
        })});

        window.open(`https://wa.me/${driverPhone}?text=${encodeURIComponent("ğŸ“¦ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯:\n" + details + "\nğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: " + total + " Ø¯Ø¬")}`);
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù…Ù‡Ø§Ù… + Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØµÙ„ Ù„Ù„Ø³ÙŠØ±ÙØ±
    async function sendTaskOrder() {
        const type = document.getElementById('task-type').value;
        const desc = document.getElementById('task-desc').value;
        const name = document.getElementById('task-name').value;
        const addr = document.getElementById('task-addr').value;
        const driverPhone = document.getElementById('task-driver').value;

        if(!desc || !driverPhone || driverPhone.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

        fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({
            type: "Ø¥Ø¯Ø§Ø±ÙŠ: " + type, customer: name, details: desc, address: addr, driverPhone: driverPhone
        })});

        window.open(`https://wa.me/${driverPhone}?text=${encodeURIComponent("ğŸ“„ Ù…Ù‡Ù…Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©:\n" + desc)}`);
    }

    window.onload = initializeApp;
    setInterval(initializeApp, 10000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
</script>
</body>

</html>



